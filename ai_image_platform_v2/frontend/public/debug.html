<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .upload-container {
            padding: 40px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        .upload-container:hover {
            background: #e9ecef;
            border-color: #0056b3;
        }
        .btn-upload-primary {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .btn-upload-primary:hover {
            background: #0056b3;
        }
        .log {
            background: #f1f1f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>AI图片处理平台 - 调试页面</h1>
    
    <div class="debug-section">
        <h3>系统状态检查</h3>
        <div id="system-status"></div>
        <button onclick="checkSystemStatus()">重新检查</button>
    </div>
    
    <div class="debug-section">
        <h3>文件选择测试</h3>
        <div class="upload-container" id="upload-container">
            <h2>点击选择图片</h2>
            <p>支持 JPG、PNG、WEBP 格式</p>
            <button class="btn-upload-primary" id="select-image-btn">
                选择照片
            </button>
        </div>
        <input type="file" id="image-input" accept="image/*" style="display: none;">
        <div id="file-status"></div>
    </div>
    
    <div class="debug-section">
        <h3>API连接测试</h3>
        <button onclick="testAPIConnection()">测试API连接</button>
        <div id="api-status"></div>
    </div>
    
    <div class="debug-section">
        <h3>调试日志</h3>
        <div id="debug-log" class="log"></div>
        <button onclick="clearLog()">清除日志</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:5002/api';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function checkSystemStatus() {
            log('开始系统状态检查');
            
            const checks = {
                'jQuery': typeof $ !== 'undefined' ? '✓ 已加载' : '✗ 未加载',
                'jQuery版本': typeof $ !== 'undefined' ? $.fn.jquery : 'N/A',
                '文件输入元素': document.getElementById('image-input') ? '✓ 存在' : '✗ 不存在',
                '上传按钮': document.getElementById('select-image-btn') ? '✓ 存在' : '✗ 不存在',
                '上传容器': document.getElementById('upload-container') ? '✓ 存在' : '✗ 不存在'
            };
            
            let statusHtml = '<h4>系统检查结果:</h4>';
            for (const [key, value] of Object.entries(checks)) {
                const isOk = value.startsWith('✓');
                statusHtml += `<div class="status ${isOk ? 'success' : 'error'}">${key}: ${value}</div>`;
                log(`${key}: ${value}`);
            }
            
            document.getElementById('system-status').innerHTML = statusHtml;
        }
        
        function testAPIConnection() {
            log('测试API连接...');
            showStatus('api-status', '正在测试API连接...', 'info');
            
            $.ajax({
                url: `${API_BASE_URL}/health`,
                type: 'GET',
                timeout: 5000,
                success: function(response) {
                    log('API连接成功');
                    showStatus('api-status', `API连接成功 - 状态: ${response.status}`, 'success');
                },
                error: function(xhr, status, error) {
                    log(`API连接失败: ${error}`, 'error');
                    showStatus('api-status', `API连接失败: ${error}`, 'error');
                }
            });
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            log(`文件选择事件触发`);
            
            if (file) {
                log(`选择了文件: ${file.name} (${file.size} bytes, ${file.type})`);
                showStatus('file-status', `已选择文件: ${file.name}<br>大小: ${(file.size/1024/1024).toFixed(2)} MB<br>类型: ${file.type}`, 'success');
                
                // 测试文件上传
                testFileUpload(file);
            } else {
                log('没有选择文件');
                showStatus('file-status', '没有选择文件', 'error');
            }
        }
        
        function testFileUpload(file) {
            log('开始测试文件上传...');
            
            const formData = new FormData();
            formData.append('file', file);
            
            $.ajax({
                url: `${API_BASE_URL}/images/upload`,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    log('文件上传成功');
                    showStatus('file-status', `文件上传成功!<br>图片ID: ${response.data?.id}<br>URL: ${response.data?.url}`, 'success');
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    log(`文件上传失败: ${response?.message || xhr.statusText}`, 'error');
                    showStatus('file-status', `文件上传失败: ${response?.message || xhr.statusText}`, 'error');
                }
            });
        }
        
        // 页面加载完成后的初始化
        $(document).ready(function() {
            log('页面加载完成，开始初始化...');
            
            // 检查系统状态
            checkSystemStatus();
            
            // 绑定文件选择事件
            $('#image-input').on('change', handleFileSelect);
            log('文件选择事件已绑定');
            
            // 绑定按钮点击事件
            $('#select-image-btn').on('click', function(e) {
                log('选择照片按钮被点击');
                e.stopPropagation();
                $('#image-input').click();
            });
            
            // 绑定容器点击事件
            $('#upload-container').on('click', function(e) {
                log('上传容器被点击');
                e.stopPropagation();
                $('#image-input').click();
            });
            
            log('所有事件绑定完成');
        });
        
        // 错误处理
        window.addEventListener('error', function(e) {
            log(`JavaScript错误: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });
        
        // 未处理的Promise拒绝
        window.addEventListener('unhandledrejection', function(e) {
            log(`未处理的Promise拒绝: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>