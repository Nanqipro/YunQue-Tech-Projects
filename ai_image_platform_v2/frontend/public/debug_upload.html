<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片上传调试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 10px; }
        #result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>图片上传调试页面</h1>
    
    <div class="debug-section">
        <h3>1. 检查API配置</h3>
        <button onclick="checkAPIConfig()">检查API配置</button>
        <div id="api-config-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. 测试登录</h3>
        <button onclick="testLogin()">测试登录</button>
        <div id="login-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. 上传图片</h3>
        <input type="file" id="file-input" accept="image/*">
        <button onclick="uploadImage()">上传图片</button>
        <div id="upload-result"></div>
    </div>
    
    <div class="debug-section">
        <h3>4. 测试美颜API</h3>
        <button onclick="testBeautyAPI()">测试美颜API</button>
        <div id="beauty-result"></div>
    </div>
    
    <div id="result"></div>
    
    <script src="assets/api/api.js"></script>
    <script>
        let uploadedImageId = null;
        
        function checkAPIConfig() {
            const resultDiv = document.getElementById('api-config-result');
            resultDiv.innerHTML = `
                <p>API Base URL: ${window.API.apiClient.config.baseURL}</p>
                <p>Current Token: ${window.API.apiClient.token || 'None'}</p>
                <p>localStorage Token: ${localStorage.getItem('authToken') || 'None'}</p>
            `;
        }
        
        async function testLogin() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = '正在登录...';
            
            try {
                const response = await window.API.userAPI.login({
                    username: 'admin',
                    password: 'admin123'
                });
                
                if (response.success) {
                    localStorage.setItem('authToken', response.data.token);
                    window.API.apiClient.setToken(response.data.token);
                    resultDiv.innerHTML = '<span style="color: green;">登录成功</span>';
                } else {
                    resultDiv.innerHTML = '<span style="color: red;">登录失败: ' + response.message + '</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: red;">登录错误: ' + error.message + '</span>';
            }
        }
        
        async function uploadImage() {
            const fileInput = document.getElementById('file-input');
            const resultDiv = document.getElementById('upload-result');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<span style="color: red;">请选择文件</span>';
                return;
            }
            
            resultDiv.innerHTML = '正在上传...';
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                const response = await fetch('http://127.0.0.1:5002/api/images/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${window.API.apiClient.token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadedImageId = result.data.id;
                    resultDiv.innerHTML = `
                        <span style="color: green;">上传成功</span><br>
                        <strong>图片ID:</strong> ${result.data.id}<br>
                        <strong>文件名:</strong> ${result.data.filename}<br>
                        <strong>URL:</strong> ${result.data.url}
                    `;
                } else {
                    resultDiv.innerHTML = '<span style="color: red;">上传失败: ' + result.message + '</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: red;">上传错误: ' + error.message + '</span>';
            }
        }
        
        async function testBeautyAPI() {
            const resultDiv = document.getElementById('beauty-result');
            
            if (!uploadedImageId) {
                resultDiv.innerHTML = '<span style="color: red;">请先上传图片</span>';
                return;
            }
            
            resultDiv.innerHTML = '正在测试美颜API...';
            
            try {
                const response = await window.API.processingAPI.beauty(uploadedImageId, {
                    smoothing: 0.3,
                    whitening: 0.4,
                    eye_enhancement: 0.6,
                    lip_enhancement: 0.25,
                    ai_mode: true
                });
                
                resultDiv.innerHTML = `
                    <span style="color: green;">美颜API测试成功</span><br>
                    <pre>${JSON.stringify(response, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = '<span style="color: red;">美颜API错误: ' + error.message + '</span>';
            }
        }
        
        // 页面加载时检查API配置
        window.onload = function() {
            checkAPIConfig();
        };
    </script>
</body>
</html>