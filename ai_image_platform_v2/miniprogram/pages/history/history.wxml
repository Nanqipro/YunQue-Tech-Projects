<!--pages/history/history.wxml-->
<view class="container">
  <!-- å¤´éƒ¨ç­›é€‰åŒºåŸŸ -->
  <view class="filter-section">
    <view class="filter-tabs">
      <view wx:for="{{filterTabs}}" wx:key="id" 
            class="filter-tab {{activeFilter === item.id ? 'active' : ''}}"
            bindtap="switchFilter" data-filter="{{item.id}}">
        {{item.name}}
      </view>
    </view>
    
    <!-- æ’åºé€‰æ‹© -->
    <view class="sort-section">
      <picker bindchange="onSortChange" value="{{sortIndex}}" range="{{sortOptions}}" range-key="name">
        <view class="sort-picker">
          <text class="sort-text">{{sortOptions[sortIndex].name}}</text>
          <text class="sort-icon">â–¼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-list">
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{historyList.length === 0 && !loading}}" class="empty-state">
      <view class="empty-icon">ğŸ“·</view>
      <text class="empty-text">æš‚æ— å¤„ç†è®°å½•</text>
      <text class="empty-desc">å¼€å§‹ä½¿ç”¨AIå›¾åƒå¤„ç†åŠŸèƒ½å§</text>
      <button class="empty-btn" bindtap="goToIndex">å¼€å§‹å¤„ç†</button>
    </view>
    
    <!-- å†å²è®°å½•é¡¹ -->
    <view wx:for="{{historyList}}" wx:key="id" class="history-item" 
          bindtap="viewHistoryDetail" data-item="{{item}}">
      <view class="item-images">
        <!-- åŸå›¾ -->
        <view class="image-container original">
          <image src="{{item.original_image_url}}" mode="aspectFill" class="history-image" />
          <text class="image-label">åŸå›¾</text>
        </view>
        
        <!-- ç®­å¤´ -->
        <view class="arrow-icon">â†’</view>
        
        <!-- å¤„ç†åå›¾ç‰‡ -->
        <view class="image-container processed">
          <image src="{{item.processed_image_url}}" mode="aspectFill" class="history-image" />
          <text class="image-label">å¤„ç†å</text>
        </view>
      </view>
      
      <!-- å¤„ç†ä¿¡æ¯ -->
      <view class="item-info">
        <view class="info-header">
          <text class="process-type">{{item.process_type_name}}</text>
          <text class="process-time">{{item.formatted_time}}</text>
        </view>
        
        <view class="info-details">
          <text class="process-desc">{{item.description}}</text>
          <view class="process-status {{item.status}}">
            <text class="status-text">{{item.status_name}}</text>
          </view>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="item-actions">
          <button class="action-btn preview" 
                  bindtap="previewImages" data-item="{{item}}" catchtap="true">
            é¢„è§ˆ
          </button>
          <button class="action-btn download" 
                  bindtap="downloadImage" data-item="{{item}}" catchtap="true">
            ä¸‹è½½
          </button>
          <button class="action-btn share" 
                  bindtap="shareImage" data-item="{{item}}" catchtap="true">
            åˆ†äº«
          </button>
          <button class="action-btn delete" 
                  bindtap="deleteHistory" data-item="{{item}}" catchtap="true">
            åˆ é™¤
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{hasMore}}" class="load-more">
    <button class="load-more-btn {{loading ? 'loading' : ''}}" 
            bindtap="loadMore" disabled="{{loading}}">
      {{loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
    </button>
  </view>
  
  <!-- æ²¡æœ‰æ›´å¤š -->
  <view wx:if="{{!hasMore && historyList.length > 0}}" class="no-more">
    <text class="no-more-text">æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
  </view>

  <!-- æ‰¹é‡æ“ä½œ -->
  <view wx:if="{{showBatchActions}}" class="batch-actions">
    <view class="batch-header">
      <text class="batch-title">å·²é€‰æ‹© {{selectedItems.length}} é¡¹</text>
      <button class="batch-cancel" bindtap="cancelBatch">å–æ¶ˆ</button>
    </view>
    
    <view class="batch-buttons">
      <button class="batch-btn download" bindtap="batchDownload">
        æ‰¹é‡ä¸‹è½½
      </button>
      <button class="batch-btn delete" bindtap="batchDelete">
        æ‰¹é‡åˆ é™¤
      </button>
    </view>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container">
    <button class="fab-btn" bindtap="toggleBatchMode">
      {{batchMode ? 'å®Œæˆ' : 'æ‰¹é‡æ“ä½œ'}}
    </button>
  </view>

  <!-- åŠ è½½é®ç½© -->
  <view wx:if="{{processing}}" class="loading-mask">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{processingText}}</text>
    </view>
  </view>
</view>